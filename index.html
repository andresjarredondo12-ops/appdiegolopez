<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Extractor de Remitos con Registro Editable y Filtro de Fechas</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    background: #f9f9f9;
  }
  input, button, select {
    padding: 8px;
    margin: 5px 0;
    box-sizing: border-box;
    width: 100%;
  }
  textarea {
    width: 100%;
    height: 120px;
    margin-top: 10px;
    font-family: monospace;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 20px;
    background: white;
  }
  th, td {
    border: 1px solid #ccc;
    padding: 6px 8px;
    text-align: left;
  }
  th {
    background: #eee;
  }
  .box {
    background: white;
    padding: 15px;
    margin-top: 15px;
  }
  td[contenteditable="true"] {
    background: #ffffe0;
    outline: none;
  }
  label {
    font-weight: bold;
    margin-top: 10px;
    display: block;
  }
  .inline-flex {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  .inline-flex > * {
    flex: 1;
    min-width: 120px;
  }
</style>
</head>
<body>

<h2>Extractor de Remitos - Registro Editable con Filtro de Fechas</h2>

<input type="file" id="imageInput" accept="image/*" />
<button onclick="procesarImagen()">Extraer Datos</button>

<p id="estado"></p>

<h3>Texto Detectado</h3>
<textarea id="textoDetectado" readonly></textarea>

<div class="box">
<h3>Datos Detectados (Editables antes de guardar)</h3>

<label>Fecha del Registro</label>
<input type="date" id="fechaRegistro" />

<label>Nombre / Razón Social</label>
<input type="text" id="nombre" placeholder="Nombre / Razón Social" />

<label>Número de Cliente</label>
<input type="text" id="cliente" placeholder="Número de Cliente" />

<label>Número de Remito</label>
<input type="text" id="remito" placeholder="Número de Remito" />

<button onclick="guardarRegistro()">Guardar Registro</button>
</div>

<div class="box">
  <h3>Filtrar Registros por Fecha</h3>
  <div class="inline-flex">
    <div>
      <label>Desde</label>
      <input type="date" id="fechaFiltroDesde" />
    </div>
    <div>
      <label>Hasta</label>
      <input type="date" id="fechaFiltroHasta" />
    </div>
  </div>
  <button onclick="mostrarRegistrosFiltrados()">Mostrar Registros</button>
  <button onclick="exportarExcelFiltrado()">Exportar Excel Filtrado</button>
</div>

<table id="tabla">
<thead>
<tr>
<th>Fecha</th>
<th>Nombre</th>
<th>Número Cliente</th>
<th>Número Remito</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
let registros = [];

function formatDateForInput(date) {
  // formato yyyy-mm-dd para input type=date
  const d = new Date(date);
  const pad = n => (n<10 ? "0"+n : n);
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}

async function procesarImagen() {
  const input = document.getElementById("imageInput");
  if (!input.files.length) {
    alert("Por favor selecciona una imagen primero.");
    return;
  }
  document.getElementById("estado").innerText = "Procesando imagen, espera...";

  const file = input.files[0];
  const imageBitmap = await createImageBitmap(file);

  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");

  canvas.width = imageBitmap.height;
  canvas.height = imageBitmap.width;

  ctx.translate(canvas.width / 2, canvas.height / 2);
  ctx.rotate(-90 * Math.PI / 180);
  ctx.drawImage(imageBitmap, -imageBitmap.width / 2, -imageBitmap.height / 2);

  const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const d = imgData.data;
  for (let i = 0; i < d.length; i += 4) {
    const avg = (d[i] + d[i + 1] + d[i + 2]) / 3;
    const val = avg > 150 ? 255 : 0;
    d[i] = d[i + 1] = d[i + 2] = val;
  }
  ctx.putImageData(imgData, 0, 0);

  const { data: { text } } = await Tesseract.recognize(canvas, "spa", {
    logger: (m) => console.log(m),
  });

  document.getElementById("textoDetectado").value = text;

  extraerDatos(text);

  document.getElementById("estado").innerText = "Datos extraídos, revisa y corrige si es necesario.";

  // Colocar fecha actual por defecto en fechaRegistro
  const hoy = new Date();
  document.getElementById("fechaRegistro").value = formatDateForInput(hoy);
}

function extraerDatos(texto) {
  const lineas = texto.split(/\r?\n/).map(l => l.trim()).filter(l => l.length > 3);

  let nombre = "";
  for (let i = 1; i < lineas.length; i++) {
    if (/IVA\s+Responsable/i.test(lineas[i])) {
      nombre = lineas[i - 1];
      break;
    }
  }

  let cliente = "";
  for (const linea of lineas) {
    const m = linea.match(/Cliente\s*[:\s]*([0-9]+)/i);
    if (m) {
      cliente = m[1];
      break;
    }
  }

  let remito = "";
  for (const linea of lineas) {
    const m = linea.match(/\b(1101|1104|0104|3008)-\d+\b/);
    if (m) {
      remito = m[0];
      break;
    }
  }

  document.getElementById("nombre").value = nombre;
  document.getElementById("cliente").value = cliente;
  document.getElementById("remito").value = remito;
}

function guardarRegistro() {
  const fechaStr = document.getElementById("fechaRegistro").value;
  const nombre = document.getElementById("nombre").value.trim();
  const cliente = document.getElementById("cliente").value.trim();
  const remito = document.getElementById("remito").value.trim();

  if (!fechaStr || !nombre || !cliente || !remito) {
    alert("Completa todos los campos antes de guardar.");
    return;
  }

  const fecha = new Date(fechaStr);
  if (isNaN(fecha.getTime())) {
    alert("Fecha inválida.");
    return;
  }

  // Guardar en registros
  registros.push({ fecha: fechaStr, nombre, cliente, remito });

  // Mostrar en tabla (editable)
  agregarFilaEditable({ fecha: fechaStr, nombre, cliente, remito });

  // Limpiar inputs excepto fecha que queda
  document.getElementById("nombre").value = "";
  document.getElementById("cliente").value = "";
  document.getElementById("remito").value = "";
}

function agregarFilaEditable({ fecha, nombre, cliente, remito }) {
  const tbody = document.querySelector("#tabla tbody");
  const fila = tbody.insertRow();

  // Fecha editable input type=date
  const celdaFecha = fila.insertCell();
  const inputFecha = document.createElement("input");
  inputFecha.type = "date";
  inputFecha.value = fecha;
  inputFecha.style.width = "130px";
  celdaFecha.appendChild(inputFecha);

  // Nombre editable contenteditable
  const celdaNombre = fila.insertCell();
  celdaNombre.contentEditable = "true";
  celdaNombre.innerText = nombre;

  // Cliente editable contenteditable
  const celdaCliente = fila.insertCell();
  celdaCliente.contentEditable = "true";
  celdaCliente.innerText = cliente;

  // Remito editable contenteditable
  const celdaRemito = fila.insertCell();
  celdaRemito.contentEditable = "true";
  celdaRemito.innerText = remito;
}

function mostrarRegistrosFiltrados() {
  const desdeStr = document.getElementById("fechaFiltroDesde").value;
  const hastaStr = document.getElementById("fechaFiltroHasta").value;

  if (!desdeStr || !hastaStr) {
    alert("Selecciona ambas fechas para filtrar.");
    return;
  }

  const desde = new Date(desdeStr);
  const hasta = new Date(hastaStr);

  if (isNaN(desde.getTime()) || isNaN(hasta.getTime()) || desde > hasta) {
    alert("Rango de fechas inválido.");
    return;
  }

  // Limpiar tabla
  const tbody = document.querySelector("#tabla tbody");
  tbody.innerHTML = "";

  // Filtrar registros y mostrarlos (editable)
  registros
    .filter(r => {
      const f = new Date(r.fecha);
      return f >= desde && f <= hasta;
    })
    .forEach(r => agregarFilaEditable(r));
}

function exportarExcelFiltrado() {
  // Leer filas visibles actuales de la tabla (tabla ya filtrada)
  const tbody = document.querySelector("#tabla tbody");
  const filas = Array.from(tbody.rows);

  if (filas.length === 0) {
    alert("No hay registros para exportar en el rango seleccionado.");
    return;
  }

  // Construir array con datos editados
  const datos = filas.map(fila => {
    const fecha = fila.cells[0].querySelector("input").value;
    const nombre = fila.cells[1].innerText.trim();
    const cliente = fila.cells[2].innerText.trim();
    const remito = fila.cells[3].innerText.trim();
    return { fecha, nombre, cliente, remito };
  });

  const ws = XLSX.utils.json_to_sheet(datos);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Remitos Filtrados");

  const fechaHoy = new Date().toISOString().split("T")[0];
  XLSX.writeFile(wb, "RemitosFiltrados_" + fechaHoy + ".xlsx");

  alert("Archivo Excel generado con registros filtrados.");
}
</script>

</body>
</html>
