<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Extractor de Remitos Mejorado</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body { font-family: Arial; padding:20px; background:#f4f6f9; }
input, button { padding:8px; margin:5px 0; width:100%; }
button { cursor:pointer; }
table { border-collapse:collapse; width:100%; margin-top:20px; background:white; }
th, td { border:1px solid #ccc; padding:8px; }
th { background:#eaeaea; }
textarea { width:100%; height:100px; }
.form-box { background:white; padding:15px; margin-top:15px; }
</style>
</head>
<body>

<h2>üìÑ Extractor de Datos desde Imagen</h2>

<input type="file" id="imageInput" accept="image/*">
<button onclick="procesarImagen()">Extraer Datos</button>

<p id="status"></p>

<h3>Texto Detectado</h3>
<textarea id="textoDetectado"></textarea>

<div class="form-box">
<h3>Datos Detectados (Editables)</h3>

<label>N√∫mero de Cuenta</label>
<input type="text" id="nroCuenta">

<label>Nombre y Apellido</label>
<input type="text" id="nombre">

<label>Domicilio</label>
<input type="text" id="direccion">

<label>N√∫mero de Remito</label>
<input type="text" id="nroRemito">

<button onclick="guardarRegistro()">Guardar Registro</button>
<button onclick="descargarExcel()">Descargar Excel</button>
</div>

<table id="tabla">
<thead>
<tr>
<th>Fecha</th>
<th>N¬∞ Cuenta</th>
<th>Nombre</th>
<th>Domicilio</th>
<th>N¬∞ Remito</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>

let registros = [];

async function procesarImagen() {

    const fileInput = document.getElementById("imageInput");
    if (!fileInput.files.length) {
        alert("Selecciona una imagen.");
        return;
    }

    document.getElementById("status").innerText = "Procesando...";

    const { data: { text } } = await Tesseract.recognize(
        fileInput.files[0],
        'spa'
    );

    document.getElementById("textoDetectado").value = text;

    // Limpieza b√°sica
    const texto = text.replace(/\n/g, " ");

    // --- Regex mejorados ---
    const nroCuenta = extraer(texto, /(cuenta|cta)[^\d]*(\d{4,})/i);
    const nroRemito = extraer(texto, /(remito|rem|n¬∞)[^\d]*(\d{3,})/i);
    const direccion = extraer(texto, /(domicilio|direcci√≥n|dir)[^A-Za-z0-9]*([A-Za-z0-9\s\.\-]+)/i);
    const nombre = extraer(texto, /(cliente|nombre|sr\.?|sra\.?)[^A-Za-z]*([A-Za-z√Å√â√ç√ì√ö√ë\s]+)/i);

    document.getElementById("nroCuenta").value = nroCuenta;
    document.getElementById("nroRemito").value = nroRemito;
    document.getElementById("direccion").value = direccion;
    document.getElementById("nombre").value = nombre;

    document.getElementById("status").innerText = "Revisa y corrige si es necesario.";
}

function extraer(texto, regex) {
    const match = texto.match(regex);
    return match ? match[2].trim() : "";
}

function guardarRegistro() {

    const fecha = new Date().toLocaleDateString();

    const registro = {
        fecha,
        nroCuenta: document.getElementById("nroCuenta").value,
        nombre: document.getElementById("nombre").value,
        direccion: document.getElementById("direccion").value,
        nroRemito: document.getElementById("nroRemito").value
    };

    registros.push(registro);

    const tabla = document.querySelector("#tabla tbody");
    const fila = tabla.insertRow();

    fila.insertCell(0).innerText = registro.fecha;
    fila.insertCell(1).innerText = registro.nroCuenta;
    fila.insertCell(2).innerText = registro.nombre;
    fila.insertCell(3).innerText = registro.direccion;
    fila.insertCell(4).innerText = registro.nroRemito;

    alert("Registro guardado.");
}

function descargarExcel() {

    if (registros.length === 0) {
        alert("No hay datos.");
        return;
    }

    const worksheet = XLSX.utils.json_to_sheet(registros);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Registros");

    const fechaHoy = new Date().toISOString().split("T")[0];
    XLSX.writeFile(workbook, "Registros_" + fechaHoy + ".xlsx");
}

</script>

</body>
</html>

