<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Extractor de Remitos - Versión Estable</title>

    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: #f4f7f6; }
        .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #2c3e50; }
        
        .upload-zone { border: 2px dashed #3498db; padding: 20px; text-align: center; border-radius: 8px; background: #ebf5fb; margin-bottom: 20px; }
        
        label { font-weight: bold; display: block; margin-top: 15px; font-size: 14px; color: #34495e; }
        input, textarea { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #dcdde1; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        
        button { width: 100%; padding: 15px; margin-top: 20px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 16px; transition: 0.3s; }
        .btn-process { background-color: #3498db; color: white; }
        .btn-save { background-color: #27ae60; color: white; }
        .btn-excel { background-color: #f39c12; color: white; }
        
        #estado { text-align: center; font-weight: bold; color: #e67e22; min-height: 24px; }
        
        .table-container { margin-top: 30px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; background: white; font-size: 13px; }
        th, td { border: 1px solid #dcdde1; padding: 10px; text-align: left; }
        th { background: #f8f9fa; }
        
        /* Ocultar canvas de procesamiento */
        #tempCanvas { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2>Extractor de Remitos</h2>
    
    <div class="upload-zone">
        <input type="file" id="imageInput" accept="image/*" />
        <button class="btn-process" onclick="iniciarProceso()">PROCESAR IMAGEN</button>
    </div>

    <p id="estado"></p>

    <canvas id="tempCanvas"></canvas>

    <div id="resultFields">
        <label>Sr.(es) / Razón Social</label>
        <input type="text" id="nombre" placeholder="Esperando datos..." />

        <label>Domicilio</label>
        <input type="text" id="domicilio" placeholder="Esperando datos..." />

        <label>Cuenta</label>
        <input type="text" id="cuenta" placeholder="Esperando datos..." />

        <label>Nro Remito</label>
        <input type="text" id="remito" placeholder="Ej: 1101-00001234" />

        <label>Fecha Registro</label>
        <input type="date" id="fecha" />

        <button class="btn-save" onclick="guardarRegistro()">GUARDAR EN LISTADO</button>
    </div>

    <div class="table-container">
        <h3>Registros Guardados</h3>
        <button class="btn-excel" onclick="exportarExcel()">EXPORTAR TODO A EXCEL</button>
        <table id="tabla">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Nombre</th>
                    <th>Nro Remito</th>
                    <th>Cuenta</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
    let db = [];

    // Inicializar fecha
    document.getElementById('fecha').value = new Date().toISOString().split('T')[0];

    async function iniciarProceso() {
        const file = document.getElementById('imageInput').files[0];
        if (!file) return alert("Selecciona una imagen primero");

        const estado = document.getElementById('estado');
        estado.innerText = "Optimizando imagen...";

        // 1. Pre-procesar imagen para mejorar OCR
        const img = new Image();
        img.src = URL.createObjectURL(file);
        img.onload = async () => {
            const canvas = document.getElementById('tempCanvas');
            const ctx = canvas.getContext('2d');
            
            // Ajustar tamaño
            canvas.width = img.width;
            canvas.height = img.height;
            
            // Filtro: Grises + Contraste
            ctx.filter = "grayscale(100%) contrast(150%)";
            ctx.drawImage(img, 0, 0);

            estado.innerText = "Leyendo texto (OCR)...";
            
            try {
                const { data: { text } } = await Tesseract.recognize(canvas, 'spa');
                procesarTexto(text);
                estado.innerText = "Lectura terminada";
            } catch (err) {
                estado.innerText = "Error en OCR";
                console.error(err);
            }
        };
    }

    function procesarTexto(rawText) {
        console.log("Texto extraído:", rawText);
        const lines = rawText.split('\n').map(l => l.trim()).filter(l => l.length > 2);
        
        // Limpiar campos previos
        document.getElementById('nombre').value = "";
        document.getElementById('domicilio').value = "";
        document.getElementById('cuenta').value = "";
        document.getElementById('remito').value = "";

        // Búsqueda de Remito (1101, 1104, 0104, 3008)
        const remitoRegex = /(1101|1104|0104|3008)[-\s]?\d+/;
        const remitoMatch = rawText.match(remitoRegex);
        if (remitoMatch) document.getElementById('remito').value = remitoMatch[0];

        // Búsqueda de Cuenta
        const cuentaMatch = rawText.match(/(Cuenta|Cta|Cliente)[:\s]?(\d+)/i);
        if (cuentaMatch) document.getElementById('cuenta').value = cuentaMatch[2];

        // Búsqueda de Nombre (Sr. es)
        for (let i = 0; i < lines.length; i++) {
            if (/Sr/i.test(lines[i])) {
                let name = lines[i].replace(/Sr(\.|\(es\))?/i, "").replace(/[:\.\-]/g, "").trim();
                // Si la línea está vacía tras quitar "Sr", el nombre es la siguiente línea
                if (name.length < 3 && lines[i+1]) name = lines[i+1];
                document.getElementById('nombre').value = name;
                break;
            }
        }
        
        // Búsqueda de Domicilio
        const domMatch = rawText.match(/Domicilio[:\s]?(.*)/i);
        if (domMatch) document.getElementById('domicilio').value = domMatch[1].trim();
    }

    function guardarRegistro() {
        const data = {
            fecha: document.getElementById('fecha').value,
            nombre: document.getElementById('nombre').value,
            domicilio: document.getElementById('domicilio').value,
            cuenta: document.getElementById('cuenta').value,
            remito: document.getElementById('remito').value
        };

        if (!data.nombre || !data.remito) {
            alert("Completa al menos el nombre y el remito antes de guardar");
            return;
        }

        db.push(data);
        renderTabla();
        
        // Limpiar para el siguiente
        document.getElementById('nombre').value = "";
        document.getElementById('domicilio').value = "";
        document.getElementById('cuenta').value = "";
        document.getElementById('remito').value = "";
        alert("Registro guardado!");
    }

    function renderTabla() {
        const tbody = document.querySelector("#tabla tbody");
        tbody.innerHTML = "";
        db.forEach(item => {
            const row = `<tr>
                <td>${item.fecha}</td>
                <td>${item.nombre}</td>
                <td>${item.remito}</td>
                <td>${item.cuenta}</td>
            </tr>`;
            tbody.innerHTML += row;
        });
    }

    function exportarExcel() {
        if (db.length === 0) return alert("No hay datos para exportar");
        const worksheet = XLSX.utils.json_to_sheet(db);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Remitos");
        XLSX.writeFile(workbook, "Remitos_Guardados.xlsx");
    }
</script>

</body>
</html>
