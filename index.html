<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Extractor de Remitos - Corrección</title>

    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

    <style>
        body { font-family: sans-serif; margin: 20px; background: #f0f2f5; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 10px; shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input, button, textarea { width: 100%; padding: 10px; margin: 8px 0; box-sizing: border-box; border: 1px solid #ccc; border-radius: 5px; }
        textarea { height: 100px; font-family: monospace; background: #fafafa; }
        label { font-weight: bold; display: block; margin-top: 10px; color: #444; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { background-color: #0056b3; }
        .btn-save { background-color: #28a745; }
        .btn-excel { background-color: #17a2b8; margin-top: 10px; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background: #f8f9fa; }
        .status { color: #d9534f; font-weight: bold; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <h2>Extractor de Remitos</h2>
    
    <label>1. Seleccionar Imagen</label>
    <input type="file" id="imageInput" accept="image/*" />
    <button onclick="procesarImagen()">Procesar y Extraer Datos</button>

    <p id="estado" class="status"></p>

    <label>Texto OCR Detectado (Referencia)</label>
    <textarea id="textoDetectado" readonly></textarea>

    <hr>

    <div id="formulario">
        <label>Sr.(es) / Razón Social</label>
        <input type="text" id="nombre" />

        <label>Domicilio</label>
        <input type="text" id="domicilio" />

        <label>Cuenta</label>
        <input type="text" id="cuenta" />

        <label>Nro Remito (1101, 1104, 0104, 3008)</label>
        <input type="text" id="remito" />

        <label>Fecha de Registro</label>
        <input type="date" id="fechaRegistro" />

        <button class="btn-save" onclick="guardarRegistro()">Guardar en Tabla</button>
    </div>

    <hr>

    <h3>Registros para Exportar</h3>
    <button class="btn-excel" onclick="exportarExcel()">Exportar Tabla a Excel</button>
    
    <table id="tablaRegistros">
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Sr.(es)</th>
                <th>Domicilio</th>
                <th>Cuenta</th>
                <th>Nro</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
let registros = [];

// Cargar fecha de hoy por defecto
window.onload = () => {
    document.getElementById('fechaRegistro').value = new Date().toISOString().split('T')[0];
};

async function procesarImagen() {
    const input = document.getElementById("imageInput");
    if (!input.files.length) return alert("Selecciona una imagen.");

    const estado = document.getElementById("estado");
    estado.innerText = "Iniciando lectura... (esto puede tardar 10-20 segundos)";

    const file = input.files[0];
    
    try {
        // Usamos Tesseract directamente sobre el archivo sin manipular el canvas
        // para evitar errores de rotación o binarización agresiva.
        const result = await Tesseract.recognize(file, 'spa', {
            logger: m => {
                if(m.status === "recognizing text") {
                    estado.innerText = `Procesando: ${Math.round(m.progress * 100)}%`;
                }
            }
        });

        const texto = result.data.text;
        document.getElementById("textoDetectado").value = texto;
        extraerCampos(texto);
        estado.innerText = "¡Lectura finalizada!";
    } catch (e) {
        console.error(e);
        estado.innerText = "Error en el procesamiento.";
    }
}

function extraerCampos(texto) {
    const lineas = texto.split('\n');
    
    // 1. Extraer Número de Remito (Patrones específicos)
    const regexRemito = /(1101|1104|0104|3008)[-\s]\d+/;
    const matchRemito = texto.match(regexRemito);
    document.getElementById("remito").value = matchRemito ? matchRemito[0] : "";

    // 2. Extraer Sr.(es)
    let nombre = "";
    for (let i = 0; i < lineas.length; i++) {
        if (/Sr\.?\(?es\)?/i.test(lineas[i])) {
            // Intenta sacar lo que sigue al texto "Sr.(es)"
            nombre = lineas[i].replace(/.*Sr\.?\(?es\)?[:\.]?\s*/i, "").trim();
            // Si la línea quedó vacía, el nombre suele estar en la de abajo
            if (nombre.length < 2 && lineas[i+1]) nombre = lineas[i+1].trim();
            break;
        }
    }
    document.getElementById("nombre").value = nombre;

    // 3. Extraer Domicilio
    const matchDom = texto.match(/Domicilio\s*[:\-]?\s*(.*)/i);
    document.getElementById("domicilio").value = matchDom ? matchDom[1].trim() : "";

    // 4. Extraer Cuenta
    const matchCta = texto.match(/(Cuenta|Cliente|Cta)\s*[:\-]?\s*(\d+)/i);
    document.getElementById("cuenta").value = matchCta ? matchCta[2] : "";
}

function guardarRegistro() {
    const reg = {
        fecha: document.getElementById("fechaRegistro").value,
        nombre: document.getElementById("nombre").value,
        domicilio: document.getElementById("domicilio").value,
        cuenta: document.getElementById("cuenta").value,
        remito: document.getElementById("remito").value
    };

    if (!reg.nombre || !reg.remito) return alert("Por favor completa Nombre y Nro.");

    registros.push(reg);
    actualizarTabla();
    
    // Limpiar campos para el siguiente
    document.getElementById("nombre").value = "";
    document.getElementById("domicilio").value = "";
    document.getElementById("cuenta").value = "";
    document.getElementById("remito").value = "";
}

function actualizarTabla() {
    const tbody = document.querySelector("#tablaRegistros tbody");
    tbody.innerHTML = "";
    registros.forEach(r => {
        const fila = `<tr>
            <td>${r.fecha}</td>
            <td>${r.nombre}</td>
            <td>${r.domicilio}</td>
            <td>${r.cuenta}</td>
            <td>${r.remito}</td>
        </tr>`;
        tbody.innerHTML += fila;
    });
}

function exportarExcel() {
    if (registros.length === 0) return alert("No hay datos en la tabla.");
    
    const ws = XLSX.utils.json_to_sheet(registros);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Remitos");
    XLSX.writeFile(wb, `Remitos_Extraidos_${new Date().getTime()}.xlsx`);
}
</script>

</body>
</html>
