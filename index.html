<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Sistema de Carga de Remitos</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body { font-family: Arial; padding:20px; background:#f4f4f4; }
input, button { padding:8px; margin:5px 0; width:100%; }
textarea { width:100%; height:120px; }
table { border-collapse:collapse; width:100%; margin-top:20px; background:white; }
th, td { border:1px solid #ccc; padding:8px; }
th { background:#eaeaea; }
.box { background:white; padding:15px; margin-top:15px; }
</style>
</head>
<body>

<h2>üìÑ Sistema de Extracci√≥n de Remitos</h2>

<input type="file" id="imageInput" accept="image/*">
<button onclick="procesarImagen()">Procesar Imagen</button>

<p id="estado"></p>

<h3>Texto OCR Detectado</h3>
<textarea id="textoOCR"></textarea>

<div class="box">
<h3>Datos Detectados (Editables)</h3>

<label>Sr.(es)</label>
<input type="text" id="nombre">

<label>Cuenta</label>
<input type="text" id="cuenta">

<label>Domicilio</label>
<input type="text" id="domicilio">

<label>N¬∞ Remito</label>
<input type="text" id="remito">

<button onclick="guardar()">Guardar Registro</button>
<button onclick="finalizar()">Finalizar y Exportar Excel</button>
</div>

<table id="tabla">
<thead>
<tr>
<th>Fecha</th>
<th>Sr.(es)</th>
<th>Cuenta</th>
<th>Domicilio</th>
<th>N¬∞ Remito</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>

let registros = [];

// ---- PROCESAMIENTO CON MEJORA DE IMAGEN ----
async function procesarImagen() {

    const input = document.getElementById("imageInput");
    if (!input.files.length) {
        alert("Seleccione una imagen.");
        return;
    }

    document.getElementById("estado").innerText = "Procesando imagen...";

    const file = input.files[0];
    const imageBitmap = await createImageBitmap(file);

    // Canvas para mejorar contraste
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    canvas.width = imageBitmap.height;  // rotamos
    canvas.height = imageBitmap.width;

    ctx.translate(canvas.width / 2, canvas.height / 2);
    ctx.rotate(-90 * Math.PI / 180);
    ctx.drawImage(imageBitmap, -imageBitmap.width/2, -imageBitmap.height/2);

    // Aumentar contraste
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = imageData.data;
    for (let i = 0; i < data.length; i += 4) {
        let avg = (data[i] + data[i+1] + data[i+2]) / 3;
        avg = avg > 150 ? 255 : 0;
        data[i] = data[i+1] = data[i+2] = avg;
    }
    ctx.putImageData(imageData, 0, 0);

    const { data: { text } } = await Tesseract.recognize(canvas, 'spa');

    document.getElementById("textoOCR").value = text;

    extraerDatos(text);

    document.getElementById("estado").innerText = "Datos detectados.";
}

// ---- EXTRACCI√ìN ESPEC√çFICA ----
function extraerDatos(texto) {

    let limpio = texto.replace(/\n/g, " ");

    // Sr.(es)
    let nombreMatch = limpio.match(/Sr\.?\s*:? ?([A-Z√Å√â√ç√ì√ö√ë\s]+)/i);
    let nombre = nombreMatch ? nombreMatch[1].trim() : "";

    // Cuenta
    let cuentaMatch = limpio.match(/Cliente[:\s]*([0-9]+)/i);
    let cuenta = cuentaMatch ? cuentaMatch[1] : "";

    // Domicilio
    let domicilioMatch = limpio.match(/Domicilio[:\s]*([A-Za-z0-9\s\.\-]+)/i);
    let domicilio = domicilioMatch ? domicilioMatch[1].trim() : "";

    // N¬∞ Remito con prefijos espec√≠ficos
    let remitoMatch = limpio.match(/(1101|1104|0104|3008)-\d+/);
    let remito = remitoMatch ? remitoMatch[0] : "";

    document.getElementById("nombre").value = nombre;
    document.getElementById("cuenta").value = cuenta;
    document.getElementById("domicilio").value = domicilio;
    document.getElementById("remito").value = remito;
}

// ---- GUARDAR REGISTRO ----
function guardar() {

    const fecha = new Date().toLocaleDateString();

    const registro = {
        fecha,
        nombre: document.getElementById("nombre").value,
        cuenta: document.getElementById("cuenta").value,
        domicilio: document.getElementById("domicilio").value,
        remito: document.getElementById("remito").value
    };

    registros.push(registro);

    const tabla = document.querySelector("#tabla tbody");
    const fila = tabla.insertRow();

    fila.insertCell(0).innerText = registro.fecha;
    fila.insertCell(1).innerText = registro.nombre;
    fila.insertCell(2).innerText = registro.cuenta;
    fila.insertCell(3).innerText = registro.domicilio;
    fila.insertCell(4).innerText = registro.remito;

    alert("Registro guardado.");
}

// ---- FINALIZAR Y EXPORTAR ----
function finalizar() {

    if (registros.length === 0) {
        alert("No hay registros.");
        return;
    }

    const ws = XLSX.utils.json_to_sheet(registros);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Remitos");

    const fechaHoy = new Date().toISOString().split("T")[0];
    XLSX.writeFile(wb, "Remitos_" + fechaHoy + ".xlsx");

    registros = [];
    document.querySelector("#tabla tbody").innerHTML = "";

    alert("Excel generado correctamente.");
}

</script>

</body>
</html>
