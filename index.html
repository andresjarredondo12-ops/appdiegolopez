<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Extractor Remitos Adaptado</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body { font-family: Arial; padding:20px; background:#f2f2f2; }
input, button { padding:8px; margin:5px 0; width:100%; }
textarea { width:100%; height:120px; }
table { border-collapse:collapse; width:100%; margin-top:20px; background:white; }
th, td { border:1px solid #ccc; padding:8px; }
th { background:#eaeaea; }
.box { background:white; padding:15px; margin-top:15px; }
</style>
</head>
<body>

<h2>Extractor de Remitos - Formato Específico</h2>

<input type="file" id="imageInput" accept="image/*">
<button onclick="procesarImagen()">Extraer Datos</button>

<p id="estado"></p>

<h3>Texto Detectado</h3>
<textarea id="textoDetectado"></textarea>

<div class="box">
<h3>Datos Detectados (Editables)</h3>

<label>Nombre / Razón Social</label>
<input type="text" id="nombre">

<label>Número de Cliente</label>
<input type="text" id="cliente">

<label>Número de Remito</label>
<input type="text" id="remito">

<button onclick="guardar()">Guardar Registro</button>
<button onclick="exportarExcel()">Exportar a Excel</button>
</div>

<table id="tabla">
<thead>
<tr>
<th>Fecha</th>
<th>Nombre</th>
<th>N° Cliente</th>
<th>N° Remito</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>

let registros = [];

async function procesarImagen() {

    const input = document.getElementById("imageInput");

    if (!input.files.length) {
        alert("Selecciona una imagen.");
        return;
    }

    document.getElementById("estado").innerText = "Procesando imagen...";

    const { data: { text } } = await Tesseract.recognize(
        input.files[0],
        'spa'
    );

    document.getElementById("textoDetectado").value = text;

    detectarDatos(text);

    document.getElementById("estado").innerText = "Revisa los datos detectados.";
}

function detectarDatos(texto) {

    // --- Nombre (línea antes de IVA Responsable) ---
    let nombreMatch = texto.match(/([A-ZÁÉÍÓÚÑ\s]+)\s+IVA Responsable/i);
    let nombre = nombreMatch ? nombreMatch[1].trim() : "";

    // --- Cliente ---
    let clienteMatch = texto.match(/Cliente[:\s]*([0-9]+)/i);
    let cliente = clienteMatch ? clienteMatch[1] : "";

    // --- Remito formato 0000-000000 ---
    let remitoMatch = texto.match(/\d{4}-\d{6}/);
    let remito = remitoMatch ? remitoMatch[0] : "";

    document.getElementById("nombre").value = nombre;
    document.getElementById("cliente").value = cliente;
    document.getElementById("remito").value = remito;
}

function guardar() {

    const fecha = new Date().toLocaleDateString();
    const nombre = document.getElementById("nombre").value;
    const cliente = document.getElementById("cliente").value;
    const remito = document.getElementById("remito").value;

    if (!nombre || !remito) {
        alert("Debe completar al menos Nombre y Remito.");
        return;
    }

    const registro = { fecha, nombre, cliente, remito };
    registros.push(registro);

    const tabla = document.querySelector("#tabla tbody");
    const fila = tabla.insertRow();

    fila.insertCell(0).innerText = fecha;
    fila.insertCell(1).innerText = nombre;
    fila.insertCell(2).innerText = cliente;
    fila.insertCell(3).innerText = remito;

    alert("Registro guardado.");
}

function exportarExcel() {

    if (registros.length === 0) {
        alert("No hay registros.");
        return;
    }

    const ws = XLSX.utils.json_to_sheet(registros);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Registros");

    const fechaHoy = new Date().toISOString().split("T")[0];
    XLSX.writeFile(wb, "Remitos_" + fechaHoy + ".xlsx");
}

</script>

</body>
</html>
