<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Extractor Inteligente de Remitos</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body { font-family: Arial; padding:20px; background:#f2f2f2; }
h2 { color:#333; }
input, button { padding:8px; margin:5px 0; width:100%; }
button { cursor:pointer; }
textarea { width:100%; height:120px; margin-top:10px; }
table { border-collapse:collapse; width:100%; margin-top:20px; background:white; }
th, td { border:1px solid #ccc; padding:8px; }
th { background:#eaeaea; }
.box { background:white; padding:15px; margin-top:15px; }
</style>
</head>
<body>

<h2>üìÑ Extractor Autom√°tico de Nombre y N¬∞ Remito</h2>

<input type="file" id="imageInput" accept="image/*">
<button onclick="procesarImagen()">Extraer Datos</button>

<p id="estado"></p>

<h3>Texto Detectado</h3>
<textarea id="textoDetectado"></textarea>

<div class="box">
<h3>Datos Detectados (Editables)</h3>

<label>Nombre y Apellido</label>
<input type="text" id="nombre">

<label>N√∫mero de Remito</label>
<input type="text" id="remito">

<button onclick="guardar()">Guardar Registro</button>
<button onclick="exportarExcel()">Exportar a Excel</button>
</div>

<table id="tabla">
<thead>
<tr>
<th>Fecha</th>
<th>Nombre</th>
<th>N¬∞ Remito</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>

let registros = [];

async function procesarImagen() {

    const input = document.getElementById("imageInput");

    if (!input.files.length) {
        alert("Selecciona una imagen.");
        return;
    }

    document.getElementById("estado").innerText = "Procesando imagen...";

    const { data: { text } } = await Tesseract.recognize(
        input.files[0],
        'spa'
    );

    document.getElementById("textoDetectado").value = text;

    detectarDatos(text);

    document.getElementById("estado").innerText = "Revisa los datos detectados.";
}

function detectarDatos(texto) {

    const lineas = texto.split("\n").map(l => l.trim()).filter(l => l.length > 0);

    let nombreDetectado = "";
    let remitoDetectado = "";

    // Detectar n√∫mero de remito (primer n√∫mero largo encontrado)
    for (let linea of lineas) {
        let numeros = linea.match(/\d{4,}/g);
        if (numeros && !remitoDetectado) {
            remitoDetectado = numeros[0];
        }
    }

    // Detectar nombre (l√≠nea con 2 o 3 palabras que empiecen en may√∫scula)
    for (let linea of lineas) {
        if (/^[A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+\s[A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+/.test(linea)) {
            nombreDetectado = linea;
            break;
        }
    }

    document.getElementById("nombre").value = nombreDetectado;
    document.getElementById("remito").value = remitoDetectado;
}

function guardar() {

    const nombre = document.getElementById("nombre").value;
    const remito = document.getElementById("remito").value;
    const fecha = new Date().toLocaleDateString();

    if (!nombre || !remito) {
        alert("Debe completar nombre y n√∫mero de remito.");
        return;
    }

    const registro = { fecha, nombre, remito };
    registros.push(registro);

    const tabla = document.querySelector("#tabla tbody");
    const fila = tabla.insertRow();

    fila.insertCell(0).innerText = fecha;
    fila.insertCell(1).innerText = nombre;
    fila.insertCell(2).innerText = remito;

    document.getElementById("nombre").value = "";
    document.getElementById("remito").value = "";

    alert("Registro guardado.");
}

function exportarExcel() {

    if (registros.length === 0) {
        alert("No hay registros.");
        return;
    }

    const ws = XLSX.utils.json_to_sheet(registros);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Registros");

    const fechaHoy = new Date().toISOString().split("T")[0];
    XLSX.writeFile(wb, "Remitos_" + fechaHoy + ".xlsx");
}

</script>

</body>
</html>
