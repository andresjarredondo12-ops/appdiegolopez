<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Extractor Remitos - Sr(es), Domicilio, Cuenta, Nro</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f0f0f0; }
  input, button, textarea { width: 100%; padding: 8px; margin: 6px 0; box-sizing: border-box; }
  textarea { height: 120px; font-family: monospace; }
  table { border-collapse: collapse; width: 100%; margin-top: 20px; background: #fff; }
  th, td { border: 1px solid #ccc; padding: 6px 8px; }
  th { background: #ddd; }
  td[contenteditable="true"] { background: #fffacd; outline: none; }
  label { font-weight: bold; margin-top: 10px; display: block; }
  .flex-row { display: flex; gap: 15px; flex-wrap: wrap; margin-top: 10px; }
  .flex-row > div { flex: 1; min-width: 140px; }
  button { cursor: pointer; background-color: #1976d2; color: white; border: none; border-radius: 4px; }
  button:hover { background-color: #1565c0; }
  .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 6px; }
</style>
</head>
<body>

<div class="container">
  <h2>Extractor de Remitos - Sr.(es), Domicilio, Cuenta, Nro</h2>

  <input type="file" id="imageInput" accept="image/*" />
  <button onclick="procesarImagen()">Procesar Imagen y Extraer Datos</button>

  <p id="estado"></p>

  <h3>Texto OCR Detectado</h3>
  <textarea id="textoDetectado" readonly></textarea>

  <div>
    <h3>Datos Extraídos (modificables antes de guardar)</h3>

    <label for="nombre">Sr.(es) / Nombre / Razón Social</label>
    <input type="text" id="nombre" placeholder="Sr.(es)" />

    <label for="domicilio">Domicilio</label>
    <input type="text" id="domicilio" placeholder="Domicilio" />

    <label for="cuenta">Cuenta</label>
    <input type="text" id="cuenta" placeholder="Cuenta" />

    <label for="remito">Nro (ej: 1101-...)</label>
    <input type="text" id="remito" placeholder="Número de remito" />

    <label for="fechaRegistro">Fecha del registro</label>
    <input type="date" id="fechaRegistro" />

    <button onclick="guardarRegistro()">Guardar Registro</button>
  </div>

  <div style="margin-top: 30px;">
    <h3>Filtrar Registros por Fecha</h3>
    <div class="flex-row">
      <div>
        <label for="fechaFiltroDesde">Desde</label>
        <input type="date" id="fechaFiltroDesde" />
      </div>
      <div>
        <label for="fechaFiltroHasta">Hasta</label>
        <input type="date" id="fechaFiltroHasta" />
      </div>
    </div>
    <button onclick="mostrarRegistrosFiltrados()">Mostrar Registros</button>
    <button onclick="exportarExcelFiltrado()">Exportar Excel Filtrado</button>
  </div>

  <table id="tabla">
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Sr.(es)</th>
        <th>Domicilio</th>
        <th>Cuenta</th>
        <th>Nro</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
let registros = [];

function formatDateForInput(date) {
  const d = new Date(date);
  const pad = n => (n < 10 ? "0" + n : n);
  return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
}

async function procesarImagen() {
  const input = document.getElementById("imageInput");
  if (!input.files.length) {
    alert("Por favor selecciona una imagen primero.");
    return;
  }
  document.getElementById("estado").innerText = "Procesando imagen, espera...";

  const file = input.files[0];
  const imageBitmap = await createImageBitmap(file);

  // Canvas para rotar imagen 90 grados (ajusta si necesario)
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");
  canvas.width = imageBitmap.height;
  canvas.height = imageBitmap.width;

  ctx.translate(canvas.width / 2, canvas.height / 2);
  ctx.rotate(-90 * Math.PI / 180);
  ctx.drawImage(imageBitmap, -imageBitmap.width / 2, -imageBitmap.height / 2);

  // Binarizar para mejor OCR
  const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const d = imgData.data;
  for (let i = 0; i < d.length; i += 4) {
    const avg = (d[i] + d[i + 1] + d[i + 2]) / 3;
    const val = avg > 150 ? 255 : 0;
    d[i] = d[i + 1] = d[i + 2] = val;
  }
  ctx.putImageData(imgData, 0, 0);

  const { data: { text } } = await Tesseract.recognize(canvas, "spa", {
    logger: m => {
      if(m.status === 'recognizing text') {
        document.getElementById("estado").innerText = `OCR: ${Math.round(m.progress * 100)}%`;
      }
    }
  });

  document.getElementById("textoDetectado").value = text;
  document.getElementById("estado").innerText = "OCR completo. Extrayendo datos...";

  extraerDatos(text);

  // Fecha actual por defecto en input fechaRegistro
  document.getElementById("fechaRegistro").value = formatDateForInput(new Date());
}

function extraerDatos(texto) {
  const lineas = texto.split(/\r?\n/).map(l => l.trim()).filter(l => l.length > 0);

  // Inicializamos variables
  let nombre = "";
  let domicilio = "";
  let cuenta = "";
  let remito = "";

  // Buscamos Sr.(es) - puede estar en línea que contiene 'Sr' o 'Sr(es)'
  for (let linea of lineas) {
    if (/Sr\.?\(es\)?/i.test(linea)) {
      // Extraer lo que siga después de "Sr(es)" o usar toda la línea (depende)
      nombre = linea.replace(/.*Sr\.?\(es\)?\.?\s*/i, "").trim();
      if (!nombre) {
        // si no hay texto después, tomar siguiente línea si existe
        let idx = lineas.indexOf(linea);
        if (idx + 1 < lineas.length) nombre = lineas[idx + 1].trim();
      }
      break;
    }
  }

  // Si no encontrado con Sr.(es), intentar tomar línea antes de IVA Responsable
  if (!nombre) {
    for (let i = 1; i < lineas.length; i++) {
      if (/IVA\s+Responsable/i.test(lineas[i])) {
        nombre = lineas[i - 1];
        break;
      }
    }
  }

  // Domicilio: línea que contenga la palabra "Domicilio"
  for (let linea of lineas) {
    let m = linea.match(/Domicilio\s*[:\-]?\s*(.+)/i);
    if (m) {
      domicilio = m[1].trim();
      break;
    }
  }

  // Cuenta: buscar línea con 'Cuenta' o 'Cliente' seguido de números
  for (let linea of lineas) {
    let m = linea.match(/(Cuenta|Cliente)\s*[:\-]?\s*(\d+)/i);
    if (m) {
      cuenta = m[2];
      break;
    }
  }

  // Número remito: buscar patrón con prefijos indicados
  for (let linea of lineas) {
    let m = linea.match(/\b(1101|1104|0104|3008)-\d+\b/);
    if (m) {
      remito = m[0];
      break;
    }
  }

  // Poner valores en inputs para edición manual
  document.getElementById("nombre").value = nombre;
  document.getElementById("domicilio").value = domicilio;
  document.getElementById("cuenta").value = cuenta;
  document.getElementById("remito").value = remito;
}

function guardarRegistro() {
  const fechaStr = document.getElementById("fechaRegistro").value;
  const nombre = document.getElementById("nombre").value.trim();
  const domicilio = document.getElementById("domicilio").value.trim();
  const cuenta = document.getElementById("cuenta").value.trim();
  const remito = document.getElementById("remito").value.trim();

  if (!fechaStr || !nombre || !cuenta || !remito) {
    alert("Completa todos los campos antes de guardar.");
    return;
  }

  registros.push({ fecha: fechaStr, nombre, domicilio, cuenta, remito });
  agregarFilaEditable({ fecha: fechaStr, nombre, domicilio, cuenta, remito });

  // Limpiar inputs menos fecha que queda para siguiente registro
  document.getElementById("nombre").value = "";
  document.getElementById("domicilio").value = "";
  document.getElementById("cuenta").value = "";
  document.getElementById("remito").value = "";
}

function agregarFilaEditable({ fecha, nombre, domicilio, cuenta, remito }) {
  const tbody = document.querySelector("#tabla tbody");
  const fila = tbody.insertRow();

  // Fecha editable input date
  const celdaFecha = fila.insertCell();
  const inputFecha = document.createElement("input");
  inputFecha.type = "date";
  inputFecha.value = fecha;
  inputFecha.style.width = "130px";
  celdaFecha.appendChild(inputFecha);

  // Nombre editable
  const celdaNombre = fila.insertCell();
  celdaNombre.contentEditable = "true";
  celdaNombre.innerText = nombre;

  // Domicilio editable
  const celdaDomicilio = fila.insertCell();
  celdaDomicilio.contentEditable = "true";
  celdaDomicilio.innerText = domicilio;

  // Cuenta editable
  const celdaCuenta = fila.insertCell();
  celdaCuenta.contentEditable = "true";
  celdaCuenta.innerText = cuenta;

  // Remito editable
  const celdaRemito = fila.insertCell();
  celdaRemito.contentEditable = "true";
  celdaRemito.innerText = remito;
}

function mostrarRegistrosFiltrados() {
  const desdeStr = document.getElementById("fechaFiltroDesde").value;
  const hastaStr = document.getElementById("fechaFiltroHasta").value;

  if (!desdeStr || !hastaStr) {
    alert("Selecciona ambas fechas para filtrar.");
    return;
  }

  const desde = new Date(desdeStr);
  const hasta = new Date(hastaStr);
  if (isNaN(desde.getTime()) || isNaN(hasta.getTime()) || desde > hasta) {
    alert("Rango de fechas inválido.");
    return;
  }

  const tbody = document.querySelector("#tabla tbody");
  tbody.innerHTML = "";

  registros
    .filter(r => {
      const f = new Date(r.fecha);
      return f >= desde && f <= hasta;
    })
    .forEach(r => agregarFilaEditable(r));
}

function exportarExcelFiltrado() {
  const tbody = document.querySelector("#tabla tbody");
  const filas = Array.from(tbody.rows);

  if (filas.length === 0) {
    alert("No hay registros para exportar en el rango seleccionado.");
    return;
  }

  const datos = filas.map(fila => {
    const fecha = fila.cells[0].querySelector("input").value;
    const nombre = fila.cells[1].innerText.trim();
    const domicilio = fila.cells[2].innerText.trim();
    const cuenta = fila.cells[3].innerText.trim();
    const remito = fila.cells[4].innerText.trim();
    return { fecha, nombre, domicilio, cuenta, remito };
  });

  const ws = XLSX.utils.json_to_sheet(datos);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Remitos Filtrados");

  const fechaHoy = new Date().toISOString().split("T")[0];
  XLSX.writeFile(wb, "RemitosFiltrados_" + fechaHoy + ".xlsx");

  alert("Archivo Excel generado con registros filtrados.");
}
</script>

</body>
</html>
