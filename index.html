<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Extractor de Remitos PRO</title>

    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background: #eceff1; color: #333; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h2 { color: #1565c0; border-bottom: 2px solid #1565c0; padding-bottom: 10px; }
        
        .upload-section { background: #f1f8ff; padding: 15px; border: 2px dashed #1e88e5; border-radius: 6px; text-align: center; margin-bottom: 20px; }
        
        input, button, textarea { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        textarea { height: 100px; font-size: 12px; background: #f9f9f9; }
        
        .grid-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        label { font-weight: bold; font-size: 0.9em; color: #555; }
        
        button { background-color: #1e88e5; color: white; font-weight: bold; border: none; cursor: pointer; transition: 0.3s; }
        button:hover { background-color: #1565c0; }
        button.secondary { background-color: #43a047; }
        button.secondary:hover { background-color: #2e7d32; }

        table { border-collapse: collapse; width: 100%; margin-top: 20px; font-size: 0.9em; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background: #1e88e5; color: white; }
        tr:nth-child(even) { background: #f2f2f2; }
        
        .status { font-weight: bold; color: #d81b60; margin: 10px 0; }
    </style>
</head>
<body>

<div class="container">
    <h2>Extractor de Datos de Remitos</h2>

    <div class="upload-section">
        <label>Seleccione la imagen del remito:</label>
        <input type="file" id="imageInput" accept="image/*" />
        <button onclick="procesarImagen()">1. Procesar y Extraer con OCR</button>
    </div>

    <p id="estado" class="status"></p>

    <div class="grid-inputs">
        <div>
            <label>Texto Bruto detectado (Referencia):</label>
            <textarea id="textoDetectado" placeholder="El texto del OCR aparecerá aquí..."></textarea>
        </div>
        <div>
            <label>Confirmar/Editar Datos:</label>
            <div class="grid-inputs">
                <div>
                    <label>Fecha Registro</label>
                    <input type="date" id="fechaRegistro" />
                </div>
                <div>
                    <label>Nro Remito</label>
                    <input type="text" id="remito" placeholder="1101-..." />
                </div>
            </div>
            
            <label>Sr.(es) / Razón Social</label>
            <input type="text" id="nombre" />

            <label>Domicilio</label>
            <input type="text" id="domicilio" />

            <label>Cuenta / Cliente</label>
            <input type="text" id="cuenta" />

            <button class="secondary" onclick="guardarRegistro()">2. Guardar en Lista</button>
        </div>
    </div>

    <hr>

    <h3>Registros Guardados</h3>
    <div style="display: flex; gap: 10px; align-items: flex-end;">
        <div style="flex: 1;">
            <label>Desde:</label>
            <input type="date" id="filtroDesde">
        </div>
        <div style="flex: 1;">
            <label>Hasta:</label>
            <input type="date" id="filtroHasta">
        </div>
        <button onclick="exportarExcel()" style="flex: 1; margin-bottom: 8px;">3. Exportar a Excel</button>
    </div>

    <table id="tablaRegistros">
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Nombre</th>
                <th>Domicilio</th>
                <th>Cuenta</th>
                <th>Nro Remito</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>
</div>

<script>
    let baseDeDatos = [];

    // Establecer fecha de hoy por defecto
    window.onload = () => {
        document.getElementById('fechaRegistro').value = new Date().toISOString().split('T')[0];
    };

    async function procesarImagen() {
        const fileInput = document.getElementById("imageInput");
        if (!fileInput.files.length) return alert("Por favor, selecciona una imagen.");

        const estado = document.getElementById("estado");
        estado.innerText = "Iniciando OCR... Por favor espera.";
        
        const image = fileInput.files[0];

        try {
            const worker = await Tesseract.createWorker('spa');
            const ret = await worker.recognize(image);
            const texto = ret.data.text;
            
            document.getElementById("textoDetectado").value = texto;
            analizarTexto(texto);
            
            await worker.terminate();
            estado.innerText = "Procesamiento completado.";
        } catch (error) {
            console.error(error);
            estado.innerText = "Error al procesar la imagen.";
        }
    }

    function analizarTexto(texto) {
        // Expresiones regulares para los campos solicitados
        const lineas = texto.split('\n');
        
        // 1. Nro Remito: Busca patrones 1101-, 1104-, 0104-, 3008-
        const regexRemito = /(1101|1104|0104|3008)-\d+/;
        const remitoMatch = texto.match(regexRemito);
        document.getElementById("remito").value = remitoMatch ? remitoMatch[0] : "";

        // 2. Sr.(es) / Nombre
        // Buscamos la línea que contiene "Sr" y tomamos el resto o la línea siguiente
        let nombre = "";
        for(let i=0; i < lineas.length; i++) {
            if(/Sr\.?\(?es\)?/i.test(lineas[i])) {
                nombre = lineas[i].replace(/.*Sr\.?\(?es\)?[:\.]?\s*/i, "").trim();
                if(nombre.length < 3 && lineas[i+1]) nombre = lineas[i+1].trim();
                break;
            }
        }
        document.getElementById("nombre").value = nombre;

        // 3. Domicilio
        let domicilio = "";
        const mDom = texto.match(/Domicilio\s*[:\-]?\s*(.*)/i);
        if(mDom) domicilio = mDom[1].trim();
        document.getElementById("domicilio").value = domicilio;

        // 4. Cuenta
        let cuenta = "";
        const mCue = texto.match(/(Cuenta|Cliente|Cta)\s*[:\-]?\s*(\d+)/i);
        if(mCue) cuenta = mCue[2];
        document.getElementById("cuenta").value = cuenta;
    }

    function guardarRegistro() {
        const nuevo = {
            fecha: document.getElementById("fechaRegistro").value,
            nombre: document.getElementById("nombre").value,
            domicilio: document.getElementById("domicilio").value,
            cuenta: document.getElementById("cuenta").value,
            remito: document.getElementById("remito").value
        };

        if(!nuevo.nombre || !nuevo.remito) {
            return alert("Mínimo se requiere Nombre y Nro de Remito.");
        }

        baseDeDatos.push(nuevo);
        actualizarTabla();
        limpiarCampos();
    }

    function actualizarTabla() {
        const tbody = document.querySelector("#tablaRegistros tbody");
        tbody.innerHTML = "";
        
        baseDeDatos.forEach(reg => {
            const fila = `<tr>
                <td>${reg.fecha}</td>
                <td>${reg.nombre}</td>
                <td>${reg.domicilio}</td>
                <td>${reg.cuenta}</td>
                <td>${reg.remito}</td>
            </tr>`;
            tbody.innerHTML += fila;
        });
    }

    function limpiarCampos() {
        document.getElementById("nombre").value = "";
        document.getElementById("domicilio").value = "";
        document.getElementById("cuenta").value = "";
        document.getElementById("remito").value = "";
        document.getElementById("textoDetectado").value = "";
    }

    function exportarExcel() {
        if(baseDeDatos.length === 0) return alert("No hay datos para exportar.");

        const desde = document.getElementById("filtroDesde").value;
        const hasta = document.getElementById("filtroHasta").value;

        let datosAExportar = baseDeDatos;

        // Filtrado si hay fechas seleccionadas
        if(desde && hasta) {
            datosAExportar = baseDeDatos.filter(r => r.fecha >= desde && r.fecha <= hasta);
        }

        if(datosAExportar.length === 0) return alert("No hay registros en ese rango de fechas.");

        const ws = XLSX.utils.json_to_sheet(datosAExportar);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Remitos Extraídos");
        
        // Generar nombre de archivo con fecha actual
        const nombreArchivo = `Reporte_Remitos_${new Date().toISOString().slice(0,10)}.xlsx`;
        XLSX.writeFile(wb, nombreArchivo);
    }
</script>

</body>
</html>
