<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Extractor de Remitos Mejorado</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    background: #f9f9f9;
  }
  input, button {
    padding: 10px;
    margin: 5px 0;
    width: 100%;
    box-sizing: border-box;
  }
  textarea {
    width: 100%;
    height: 120px;
    margin-top: 10px;
    font-family: monospace;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 20px;
    background: white;
  }
  th, td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: left;
  }
  th {
    background: #eee;
  }
  .box {
    background: white;
    padding: 15px;
    margin-top: 15px;
  }
</style>
</head>
<body>

<h2>Extractor de Remitos - Versión Mejorada</h2>

<input type="file" id="imageInput" accept="image/*" />
<button onclick="procesarImagen()">Extraer Datos</button>

<p id="estado"></p>

<h3>Texto Detectado</h3>
<textarea id="textoDetectado" readonly></textarea>

<div class="box">
<h3>Datos Detectados (Editables)</h3>

<label>Nombre / Razón Social</label>
<input type="text" id="nombre" placeholder="Nombre / Razón Social" />

<label>Número de Cliente</label>
<input type="text" id="cliente" placeholder="Número de Cliente" />

<label>Número de Remito</label>
<input type="text" id="remito" placeholder="Número de Remito" />

<button onclick="guardarRegistro()">Guardar Registro</button>
<button onclick="exportarExcel()">Finalizar y Exportar Excel</button>
</div>

<table id="tabla">
<thead>
<tr>
<th>Fecha</th>
<th>Nombre</th>
<th>Número Cliente</th>
<th>Número Remito</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
let registros = [];

async function procesarImagen() {
  const input = document.getElementById("imageInput");
  if (!input.files.length) {
    alert("Por favor selecciona una imagen primero.");
    return;
  }
  document.getElementById("estado").innerText = "Procesando imagen, espera...";

  const file = input.files[0];
  const imageBitmap = await createImageBitmap(file);

  // Canvas para rotar y mejorar imagen (180 grados si está horizontal invertida)
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");

  // Suponemos imagen vertical, rotamos -90 grados para que quede horizontal legible
  canvas.width = imageBitmap.height;
  canvas.height = imageBitmap.width;

  ctx.translate(canvas.width / 2, canvas.height / 2);
  ctx.rotate(-90 * Math.PI / 180);
  ctx.drawImage(imageBitmap, -imageBitmap.width / 2, -imageBitmap.height / 2);

  // Mejorar contraste (binarizar)
  const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const d = imgData.data;
  for (let i = 0; i < d.length; i += 4) {
    // promedio de RGB
    const avg = (d[i] + d[i + 1] + d[i + 2]) / 3;
    const val = avg > 150 ? 255 : 0; // umbral
    d[i] = d[i + 1] = d[i + 2] = val;
  }
  ctx.putImageData(imgData, 0, 0);

  // Ejecutar OCR
  const { data: { text } } = await Tesseract.recognize(canvas, "spa", {
    logger: (m) => console.log(m),
    // Puedes agregar opciones aquí si quieres, por ejemplo:
    // tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789- ',
  });

  document.getElementById("textoDetectado").value = text;

  // Extraer datos
  extraerDatos(text);
  document.getElementById("estado").innerText = "Datos extraídos, revisa y corrige si es necesario.";
}

function extraerDatos(texto) {
  // Dividir en líneas y limpiar líneas muy cortas
  const lineas = texto.split(/\r?\n/).map(l => l.trim()).filter(l => l.length > 3);

  // Buscar línea con IVA Responsable y tomar la anterior como nombre
  let nombre = "";
  for (let i = 1; i < lineas.length; i++) {
    if (/IVA\s+Responsable/i.test(lineas[i])) {
      nombre = lineas[i - 1];
      break;
    }
  }

  // Buscar "Cliente" seguido de número
  let cliente = "";
  for (const linea of lineas) {
    const m = linea.match(/Cliente\s*[:\s]*([0-9]+)/i);
    if (m) {
      cliente = m[1];
      break;
    }
  }

  // Buscar número de remito que empiece con alguno de los prefijos indicados
  let remito = "";
  for (const linea of lineas) {
    const m = linea.match(/\b(1101|1104|0104|3008)-\d+\b/);
    if (m) {
      remito = m[0];
      break;
    }
  }

  document.getElementById("nombre").value = nombre;
  document.getElementById("cliente").value = cliente;
  document.getElementById("remito").value = remito;
}

function guardarRegistro() {
  const nombre = document.getElementById("nombre").value.trim();
  const cliente = document.getElementById("cliente").value.trim();
  const remito = document.getElementById("remito").value.trim();

  if (!nombre || !cliente || !remito) {
    alert("Por favor completa todos los campos antes de guardar.");
    return;
  }

  const fecha = new Date().toLocaleDateString();

  registros.push({ fecha, nombre, cliente, remito });

  const tbody = document.querySelector("#tabla tbody");
  const fila = tbody.insertRow();

  fila.insertCell(0).innerText = fecha;
  fila.insertCell(1).innerText = nombre;
  fila.insertCell(2).innerText = cliente;
  fila.insertCell(3).innerText = remito;

  alert("Registro guardado correctamente.");

  // Limpiar inputs para siguiente registro
  document.getElementById("nombre").value = "";
  document.getElementById("cliente").value = "";
  document.getElementById("remito").value = "";
}

function exportarExcel() {
  if (registros.length === 0) {
    alert("No hay registros para exportar.");
    return;
  }

  const ws = XLSX.utils.json_to_sheet(registros);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Remitos");

  const fechaHoy = new Date().toISOString().split("T")[0];
  XLSX.writeFile(wb, "Remitos_" + fechaHoy + ".xlsx");

  registros = [];
  document.querySelector("#tabla tbody").innerHTML = "";

  alert("Archivo Excel generado y registros limpiados.");
}
</script>

</body>
</html>
