<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Extractor de Remitos - Estable</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body { font-family: Arial; padding:20px; background:#f4f4f9; }
.container { max-width:700px; margin:auto; background:white; padding:20px; border-radius:10px; }
.upload-box { background:#e7f3ff; border:2px dashed #007bff; padding:20px; text-align:center; border-radius:8px; margin-bottom:20px; }
label { font-weight:bold; display:block; margin-top:15px; }
input { width:100%; padding:10px; margin-top:5px; border:1px solid #ccc; border-radius:5px; }
button { width:100%; padding:12px; margin-top:15px; border:none; border-radius:5px; font-weight:bold; cursor:pointer; }
.btn-blue { background:#007bff; color:white; }
.btn-green { background:#28a745; color:white; }
.btn-orange { background:#fd7e14; color:white; }
#estado { text-align:center; font-weight:bold; margin:10px 0; }
table { width:100%; border-collapse:collapse; margin-top:20px; }
th, td { border:1px solid #ddd; padding:8px; }
th { background:#f1f1f1; }
#tempCanvas { display:none; }
</style>
</head>
<body>

<div class="container">
<h2>Extractor de Remitos</h2>

<div class="upload-box">
<input type="file" id="imageInput" accept="image/*" />
<button class="btn-blue" onclick="ejecutarLectura()">PROCESAR IMAGEN</button>
</div>

<p id="estado"></p>
<canvas id="tempCanvas"></canvas>

<label>Sr.(es) / Nombre</label>
<input type="text" id="nombre" />

<label>Cuenta</label>
<input type="text" id="cuenta" />

<label>Nro Remito</label>
<input type="text" id="remito" />

<label>Fecha</label>
<input type="date" id="fechaReg" />

<button class="btn-green" onclick="guardarEnTabla()">GUARDAR REGISTRO</button>
<button class="btn-orange" onclick="exportarExcel()">EXPORTAR A EXCEL</button>

<table id="tablaRegistros">
<thead>
<tr>
<th>Fecha</th>
<th>Nombre</th>
<th>Cuenta</th>
<th>Remito</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<script>
let baseDatos = [];
document.getElementById('fechaReg').value = new Date().toISOString().split('T')[0];

async function ejecutarLectura() {

const file = document.getElementById('imageInput').files[0];
if (!file) {
alert("Selecciona una imagen");
return;
}

const estado = document.getElementById("estado");
estado.innerText = "Procesando imagen...";

try {

const img = new Image();
img.src = URL.createObjectURL(file);

img.onload = async () => {

const canvas = document.getElementById("tempCanvas");
const ctx = canvas.getContext("2d");

canvas.width = img.width * 1.4;
canvas.height = img.height * 1.4;

ctx.filter = "contrast(1.6) grayscale(1)";
ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

const result = await Tesseract.recognize(canvas, "spa");
const texto = result.data.text;

estado.innerText = "Lectura finalizada ✔";

extraerInformacion(texto);
};

} catch (error) {
estado.innerText = "Error al procesar imagen";
console.error(error);
}
}

function extraerInformacion(texto) {

const lineas = texto.split("\n")
.map(l => l.trim())
.filter(l => l.length > 3);

let cuenta = "";
let nombre = "";
let remito = "";

// RECORREMOS LÍNEAS
for (let linea of lineas) {

// ---- CUENTA ----
if (/Cuenta/i.test(linea)) {
let matchCuenta = linea.match(/\d{4,12}/);
if (matchCuenta) cuenta = matchCuenta[0];
continue; // ESTA LINEA NO PUEDE SER NOMBRE
}

// ---- REMITO ----
if (!remito) {
let matchRemito = linea.match(/\b(1101|1104|0104|3008)[-\s]?\d+\b/);
if (matchRemito) {
remito = matchRemito[0];
continue;
}
}

// ---- NOMBRE ----
if (!nombre) {
if (!/Cuenta|Remito|Fecha|Factura|IVA|Total/i.test(linea)) {

if (/Sr|Señor|Cliente/i.test(linea)) {
nombre = linea.replace(/Sr\.?|Señor|Cliente|:/gi, "").trim();
} 
else if (/^[A-ZÁÉÍÓÚÑ\s]{5,}$/.test(linea)) {
nombre = linea.trim();
}
}
}

}

document.getElementById("cuenta").value = cuenta;
document.getElementById("remito").value = remito;
document.getElementById("nombre").value = nombre;
}

function guardarEnTabla() {

const reg = {
fecha: document.getElementById("fechaReg").value,
nombre: document.getElementById("nombre").value,
cuenta: document.getElementById("cuenta").value,
remito: document.getElementById("remito").value
};

if (!reg.nombre && !reg.remito) {
alert("No hay datos suficientes.");
return;
}

baseDatos.push(reg);
actualizarTabla();
limpiarCampos();
}

function actualizarTabla() {
const tbody = document.querySelector("#tablaRegistros tbody");
tbody.innerHTML = "";
baseDatos.forEach(r => {
tbody.innerHTML += `
<tr>
<td>${r.fecha}</td>
<td>${r.nombre}</td>
<td>${r.cuenta}</td>
<td>${r.remito}</td>
</tr>`;
});
}

function limpiarCampos() {
document.getElementById("nombre").value = "";
document.getElementById("cuenta").value = "";
document.getElementById("remito").value = "";
document.getElementById("imageInput").value = "";
}

function exportarExcel() {
if (baseDatos.length === 0) {
alert("No hay registros");
return;
}
const ws = XLSX.utils.json_to_sheet(baseDatos);
const wb = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb, ws, "Remitos");
XLSX.writeFile(wb, "Registros_Remitos.xlsx");
}
</script>

</body>
</html>

